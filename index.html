<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cloud Native Gateway</title>
  <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
  <script src="lib/mapbox-gl-rtl-text.min.js"></script>
  <script src="https://unpkg.com/shpjs@4.0.4/dist/shp.js"></script>
  <!-- gdal3.js loaded from CDN so GitHub Pages doesn't need to serve it -->
  <script src="https://cdn.jsdelivr.net/npm/gdal3.js@2.8.1/dist/package/gdal3.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --accent:        #5eead4;
      --accent-dim:    rgba(94,234,212,.15);
      --accent-border: rgba(94,234,212,.3);
      --purple:        #a78bfa;
      --bg:            #080c12;
      --panel:         #0e1420;
      --panel-2:       #151c2b;
      --border:        rgba(255,255,255,.07);
      --border-hi:     rgba(255,255,255,.13);
      --text:          #e2e8f0;
      --muted:         #64748b;
      --layer-colors:  #5eead4,#f472b6,#fb923c,#60a5fa,#a78bfa,#34d399,#facc15,#f87171;
    }

    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
    }

    /* ── SIDEBAR ─────────────────────────────────────────── */
    .sidebar {
      width: 340px;
      flex-shrink: 0;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Header */
    .sidebar-head {
      padding: 22px 20px 18px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .wordmark {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .wordmark-icon {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .wordmark-icon svg { width: 16px; height: 16px; fill: #0e1420; }
    .wordmark-text {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -.02em;
      color: var(--text);
    }

    /* Upload zone */
    .upload-wrap { padding: 14px 14px 0; flex-shrink: 0; }

    .upload-zone {
      border: 1.5px dashed var(--border-hi);
      border-radius: 16px;
      padding: 22px 16px;
      text-align: center;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      background: rgba(255,255,255,.02);
      position: relative;
    }
    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--accent-border);
      background: var(--accent-dim);
    }
    .upload-zone.dragover { transform: scale(1.01); }

    .upload-zone input { display: none; }

    .uz-icon {
      width: 40px; height: 40px;
      margin: 0 auto 10px;
      border-radius: 12px;
      background: var(--accent-dim);
      border: 1px solid var(--accent-border);
      display: flex; align-items: center; justify-content: center;
    }
    .uz-icon svg { width: 18px; height: 18px; stroke: var(--accent); fill: none; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; }

    .uz-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
    .uz-hint { font-size: 11px; color: var(--muted); margin-bottom: 14px; }

    .uz-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: var(--accent);
      color: #0a1018;
      font-size: 12px; font-weight: 700;
      border: none; border-radius: 20px;
      padding: 8px 18px; cursor: pointer;
      transition: opacity .15s, transform .15s;
      letter-spacing: .01em;
    }
    .uz-btn:hover { opacity: .88; transform: translateY(-1px); }

    /* Processing panel */
    .proc-panel {
      margin: 10px 14px 0;
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      display: none;
      flex-shrink: 0;
    }
    .proc-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .proc-label { font-size: 12px; font-weight: 600; }
    .proc-pct { font-size: 12px; color: var(--accent); font-weight: 700; font-variant-numeric: tabular-nums; }
    .proc-bar-track {
      height: 3px;
      background: var(--border);
      border-radius: 99px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .proc-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--purple));
      width: 0%;
      transition: width .25s ease;
      border-radius: 99px;
    }
    .proc-file {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Layers section */
    .layers-wrap {
      flex: 1;
      overflow-y: auto;
      padding: 0 14px 14px;
      margin-top: 10px;
    }
    .layers-wrap::-webkit-scrollbar { width: 4px; }
    .layers-wrap::-webkit-scrollbar-track { background: transparent; }
    .layers-wrap::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 4px; }

    .layers-label {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 6px 2px 8px;
    }

    .layer-card {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 13px;
      margin-bottom: 8px;
      overflow: hidden;
      transition: border-color .15s;
    }
    .layer-card:hover { border-color: var(--border-hi); }

    .layer-head {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 10px 12px;
    }
    .layer-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
      box-shadow: 0 0 8px currentColor;
    }
    .layer-name-wrap { flex: 1; min-width: 0; }
    .layer-name {
      font-size: 12px; font-weight: 600;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .layer-geom { font-size: 10px; color: var(--muted); margin-top: 1px; }

    .layer-actions { display: flex; gap: 2px; }
    .la-btn {
      width: 26px; height: 26px;
      background: none; border: none; cursor: pointer;
      color: var(--muted);
      border-radius: 7px;
      display: flex; align-items: center; justify-content: center;
      transition: background .12s, color .12s;
    }
    .la-btn:hover { background: rgba(255,255,255,.06); color: var(--text); }
    .la-btn.del:hover { background: rgba(248,113,113,.12); color: #f87171; }
    .la-btn svg { width: 13px; height: 13px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    .layer-exports {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 5px;
      padding: 0 10px 10px;
    }
    .exp-btn {
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 4px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: .01em;
      color: var(--muted);
      cursor: pointer;
      text-align: center;
      transition: all .13s;
    }
    .exp-btn:hover {
      background: var(--accent-dim);
      border-color: var(--accent-border);
      color: var(--accent);
    }
    .exp-btn.wide { grid-column: span 3; font-size: 11px; padding: 7px; }

    /* ── MAP ─────────────────────────────────────────────── */
    .map-wrap { flex: 1; position: relative; }
    #map { width: 100%; height: 100vh; }

    .map-badge {
      position: absolute; bottom: 24px; left: 16px; z-index: 10;
      background: rgba(8,12,18,.82);
      border: 1px solid var(--border-hi);
      border-radius: 20px;
      padding: 5px 14px;
      font-size: 11px;
      color: rgba(255,255,255,.5);
      backdrop-filter: blur(8px);
      pointer-events: none;
    }

    /* MapLibre popup overrides */
    .maplibregl-popup-content {
      background: #0e1420 !important;
      border: 1px solid rgba(255,255,255,.1) !important;
      border-radius: 12px !important;
      padding: 0 !important;
      box-shadow: 0 12px 40px rgba(0,0,0,.6) !important;
      min-width: 210px; max-width: 300px;
    }
    .maplibregl-popup-tip {
      border-top-color: #0e1420 !important;
      border-bottom-color: #0e1420 !important;
    }
    .maplibregl-popup-close-button {
      color: rgba(255,255,255,.3) !important;
      font-size: 16px !important;
      padding: 8px 10px !important;
      line-height: 1 !important;
    }
    .pop-head {
      padding: 9px 32px 9px 13px;
      border-radius: 12px 12px 0 0;
      font-size: 12px; font-weight: 700;
    }
    .pop-table { width: 100%; border-collapse: collapse; }
    .pop-table tr { border-bottom: 1px solid rgba(255,255,255,.05); }
    .pop-table tr:last-child { border-bottom: none; }
    .pop-table td { padding: 5px 13px; font-size: 11px; line-height: 1.4; }
    .pop-table td:first-child { color: rgba(255,255,255,.38); width: 38%; }
    .pop-table td:last-child { color: var(--text); font-weight: 500; word-break: break-word; }
  </style>
</head>
<body>

<!-- ═══════════════════════════════════ SIDEBAR ══════════════════════════════════ -->
<div class="sidebar">

  <!-- Header -->
  <div class="sidebar-head">
    <div class="wordmark">
      <div class="wordmark-icon">
        <!-- Globe icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="#0e1420" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:17px;height:17px">
          <circle cx="12" cy="12" r="10"/>
          <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10A15.3 15.3 0 0 1 8 12a15.3 15.3 0 0 1 4-10z"/>
        </svg>
      </div>
      <div>
        <div class="wordmark-text">Cloud Native Gateway</div>
      </div>
    </div>
  </div>

  <!-- Upload zone -->
  <div class="upload-wrap">
    <div id="dropZone" class="upload-zone">
      <input id="fileInput" type="file" accept=".zip,.gpkg,.geojson,.json,.csv" multiple>
      <div class="uz-icon">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      <div class="uz-title">Drop files here</div>
      <div class="uz-hint">Shapefile · GeoPackage · GeoJSON · CSV</div>
      <button class="uz-btn" id="browseButton" type="button">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
        Choose Files
      </button>
    </div>
  </div>

  <!-- Processing panel -->
  <div class="proc-panel" id="procPanel">
    <div class="proc-row">
      <span class="proc-label" id="procLabel">Processing…</span>
      <span class="proc-pct" id="procPct">0%</span>
    </div>
    <div class="proc-bar-track"><div class="proc-bar-fill" id="procBar"></div></div>
    <div class="proc-file" id="procFile">—</div>
  </div>

  <!-- Layers -->
  <div class="layers-wrap" id="layersWrap" style="display:none">
    <div class="layers-label">Layers</div>
    <div id="layerCards"></div>
  </div>

</div>

<!-- ═══════════════════════════════════ MAP ═════════════════════════════════════ -->
<div class="map-wrap">
  <div id="map"></div>
  <div class="map-badge" id="mapBadge">No data loaded</div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════
// BASEMAP  — OpenFreeMap "Bright" style (free, no key, vector tiles)
// Beautiful vector basemap with crisp labels, terrain shading, roads
// ═══════════════════════════════════════════════════════════════════
const BASEMAP_STYLE = 'https://tiles.openfreemap.org/styles/bright';

maplibregl.setRTLTextPlugin(
  'lib/mapbox-gl-rtl-text.min.js',
  false,
  (error) => console.warn('RTL plugin error:', error)
);

const map = new maplibregl.Map({
  container: 'map',
  style: BASEMAP_STYLE,
  center: [20, 20],
  zoom: 2,
  attributionControl: true
});
map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
map.addControl(new maplibregl.ScaleControl({ unit: 'metric' }), 'bottom-left');

// Ensure labels are visible when map loads
map.on('load', () => {
  map.getStyle().layers.forEach(layer => {
    if (layer.type === 'symbol') {
      map.setLayoutProperty(layer.id, 'visibility', 'visible');
    }
  });
});

// ═══════════════════════
// STATE
// ═══════════════════════
const state = {
  layers: [],
  gdal: null,
  gdalAvailable: false
};

const COLORS = ['#5eead4','#f472b6','#fb923c','#60a5fa','#a78bfa','#34d399','#facc15','#f87171'];

// ═══════════════════════
// UI REFS
// ═══════════════════════
const dropZone    = document.getElementById('dropZone');
const fileInput   = document.getElementById('fileInput');
const browseBtn   = document.getElementById('browseButton');
const procPanel   = document.getElementById('procPanel');
const procLabel   = document.getElementById('procLabel');
const procPct     = document.getElementById('procPct');
const procBar     = document.getElementById('procBar');
const procFile    = document.getElementById('procFile');
const mapBadge    = document.getElementById('mapBadge');
const layersWrap  = document.getElementById('layersWrap');
const layerCards  = document.getElementById('layerCards');

// ═══════════════════════
// DRAG & DROP
// ═══════════════════════
['dragenter','dragover','dragleave','drop'].forEach(ev =>
  dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
['dragenter','dragover'].forEach(ev =>
  dropZone.addEventListener(ev, () => dropZone.classList.add('dragover')));
['dragleave','drop'].forEach(ev =>
  dropZone.addEventListener(ev, () => dropZone.classList.remove('dragover')));

dropZone.addEventListener('drop', e => {
  const files = Array.from(e.dataTransfer.files);
  if (files.length) processFiles(files);
});
browseBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => {
  if (e.target.files.length) processFiles(Array.from(e.target.files));
});

// ═══════════════════════
// PROGRESS UI
// ═══════════════════════
function setProgress(pct, label, file) {
  procPanel.style.display = 'block';
  procPct.textContent     = Math.round(pct) + '%';
  procBar.style.width     = pct + '%';
  if (label) procLabel.textContent = label;
  if (file)  procFile.textContent  = file;
}

// ═══════════════════════
// GDAL INIT
// ═══════════════════════
async function initGDAL() {
  setProgress(5, 'Loading GDAL…', 'gdal3.js');

  let attempts = 0;
  while (typeof window.initGdalJs !== 'function' && attempts < 100) {
    await new Promise(r => setTimeout(r, 100));
    attempts++;
  }
  if (typeof window.initGdalJs !== 'function') throw new Error('initGdalJs not found');

  setProgress(15, 'Initialising GDAL…', 'gdal3WebAssembly.wasm');
  // Compute absolute base URL so GitHub Pages subpath works correctly
  const gdalBasePath = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
  const inst = await window.initGdalJs({ path: gdalBasePath, useWorker: false });

  if (!inst) throw new Error('initGdalJs returned null');
  state.gdal = typeof inst.open === 'function' ? inst
             : inst.GDAL3 ? inst.GDAL3 : inst;
  state.gdalAvailable = true;

  setProgress(100, 'GDAL ready', '');
  setTimeout(() => { procPanel.style.display = 'none'; }, 1200);
}

async function convertWithOgr2ogr(file) {
  const gdal   = state.gdal;
  const opened = await gdal.open(file);
  if (!opened?.datasets?.length) {
    throw new Error('GDAL could not open file: ' + (opened?.errors?.map(e=>e.message).join(', ') || '?'));
  }
  const ds     = opened.datasets[0];
  const result = await gdal.ogr2ogr(ds, ['-f','GeoJSON','-t_srs','EPSG:4326']);
  const text   = gdal.Module.FS.readFile(result.local, { encoding: 'utf8' });
  try { await gdal.close(ds); } catch(e) {}
  return JSON.parse(text);
}

// ═══════════════════════
// MULTI-FILE PROCESSING
// ═══════════════════════
async function processFiles(files) {
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const base = i / files.length * 100;
    const step = 100 / files.length;
    setProgress(base + step * .1, `File ${i+1} of ${files.length}`, file.name);
    try {
      const geojson = await processSingleFile(file, pct => setProgress(base + step * pct / 100, null, file.name));
      addLayer(file.name.replace(/\.[^.]+$/, ''), geojson);
    } catch(err) {
      console.error('Error:', file.name, err);
    }
    setProgress(base + step, null, file.name);
  }
  setProgress(100, 'Complete', '');
  updateBadge();
  fitAllLayers();
  setTimeout(() => { procPanel.style.display = 'none'; }, 1400);
}

async function processSingleFile(file, onProgress) {
  const ext = file.name.split('.').pop().toLowerCase();
  let geojson;

  if (ext === 'zip') {
    onProgress(20);
    if (state.gdalAvailable) {
      try { geojson = await convertWithOgr2ogr(file); onProgress(90); }
      catch(e) { console.warn('GDAL zip failed, trying shp.js', e); }
    }
    if (!geojson) {
      onProgress(30);
      const buf = await file.arrayBuffer();
      onProgress(60);
      const res = await shp(buf);
      onProgress(90);
      geojson = Array.isArray(res)
        ? { type:'FeatureCollection', features: res.flatMap(l => l.features || []) }
        : res;
    }
  } else if (ext === 'gpkg') {
    onProgress(20);
    if (!state.gdalAvailable) throw new Error('GDAL not available for .gpkg');
    geojson = await convertWithOgr2ogr(file);
    onProgress(90);
  } else if (ext === 'geojson' || ext === 'json') {
    onProgress(30);
    const text = await file.text();
    onProgress(70);
    let parsed = JSON.parse(text);
    if (parsed.type === 'Feature') parsed = { type:'FeatureCollection', features:[parsed] };
    geojson = parsed;
    onProgress(90);
  } else if (ext === 'csv') {
    onProgress(30);
    geojson = csvToGeoJSON(await file.text());
    onProgress(90);
  } else {
    throw new Error('Unsupported: .' + ext);
  }

  if (!geojson?.features?.length) throw new Error('No features in ' + file.name);
  return geojson;
}

// ═══════════════════════
// LAYER MANAGEMENT
// ═══════════════════════
function addLayer(name, geojson) {
  const idx      = state.layers.length;
  const color    = COLORS[idx % COLORS.length];
  const id       = 'lyr-' + idx;
  const geomType = geojson.features[0]?.geometry?.type || 'Unknown';
  state.layers.push({ id, name, geojson, color, visible: true, geomType });

  const doAdd = () => addMapLayer(id, geojson, color, geomType);
  map.isStyleLoaded() ? doAdd() : map.once('load', doAdd);

  layersWrap.style.display = 'block';

  const card = document.createElement('div');
  card.className = 'layer-card';
  card.id = 'card-' + id;
  card.innerHTML = `
    <div class="layer-head">
      <div class="layer-dot" style="background:${color};color:${color}"></div>
      <div class="layer-name-wrap">
        <div class="layer-name" title="${name}">${name}</div>
        <div class="layer-geom">${geojson.features.length} features · ${geomType}</div>
      </div>
      <div class="layer-actions">
        <button class="la-btn" title="Toggle" onclick="toggleLayer('${id}')">
          <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
        <button class="la-btn" title="Zoom to" onclick="zoomToLayer('${id}')">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
        </button>
        <button class="la-btn del" title="Remove" onclick="removeLayer('${id}')">
          <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
        </button>
      </div>
    </div>
    <div class="layer-exports">
      <button class="exp-btn" onclick="exportLayer('${id}','fgb')">FlatGeobuf</button>
      <button class="exp-btn" onclick="exportLayer('${id}','pmtiles')">PMTiles</button>
      <button class="exp-btn" onclick="exportLayer('${id}','parquet')">GeoParquet</button>
      <button class="exp-btn wide" onclick="exportLayer('${id}','html')">Export Interactive Map</button>
    </div>`;
  layerCards.appendChild(card);
}

function addMapLayer(id, geojson, color, geomType) {
  if (map.getSource(id)) return;
  map.addSource(id, { type:'geojson', data:geojson, generateId:true });

  if (geomType.includes('Point')) {
    map.addLayer({ id:id+'-sym', type:'circle', source:id, paint:{
      'circle-radius':['interpolate',['linear'],['zoom'],4,3,12,7,18,13],
      'circle-color':color,'circle-opacity':.9,
      'circle-stroke-width':1.5,'circle-stroke-color':'rgba(0,0,0,.4)'
    }});
  } else if (geomType.includes('Line')) {
    map.addLayer({ id:id+'-sym', type:'line', source:id, paint:{
      'line-color':color,'line-width':2.5,'line-opacity':.9,
      'line-blur':0.5
    }});
  } else {
    map.addLayer({ id:id+'-fill', type:'fill', source:id, paint:{
      'fill-color':color,'fill-opacity':.35
    }});
    map.addLayer({ id:id+'-sym', type:'line', source:id, paint:{
      'line-color':color,'line-width':1.8,'line-opacity':.9
    }});
  }

  // Popup
  map.on('click', id+'-sym', e => {
    const props = e.features[0]?.properties || {};
    const entries = Object.entries(props);
    const nameKey = Object.keys(props).find(k => /name|label|title/i.test(k));
    const title   = nameKey ? String(props[nameKey]) : 'Feature';
    const rows    = entries.map(([k,v]) =>
      `<tr><td>${k}</td><td>${String(v).substring(0,120)}</td></tr>`).join('');
    new maplibregl.Popup({ maxWidth:'300px', offset:8 })
      .setLngLat(e.lngLat)
      .setHTML(`<div class="pop-head" style="background:${color}22;border-bottom:2px solid ${color}">${title}</div>
                <table class="pop-table">${rows}</table><div style="height:4px"></div>`)
      .addTo(map);
  });
  map.on('mouseenter', id+'-sym', () => map.getCanvas().style.cursor = 'pointer');
  map.on('mouseleave', id+'-sym', () => map.getCanvas().style.cursor = '');
}

function toggleLayer(id) {
  const layer = state.layers.find(l => l.id === id);
  if (!layer) return;
  layer.visible = !layer.visible;
  const vis = layer.visible ? 'visible' : 'none';
  [id+'-fill',id+'-sym',id+'-outline'].forEach(lid => {
    if (map.getLayer(lid)) map.setLayoutProperty(lid,'visibility',vis);
  });
  const btn = document.querySelector(`#card-${id} .la-btn`);
  if (btn) btn.style.opacity = layer.visible ? '1' : '.3';
}

function zoomToLayer(id) {
  const layer = state.layers.find(l => l.id === id);
  if (!layer) return;
  let mn=[Infinity,Infinity], mx=[-Infinity,-Infinity];
  layer.geojson.features.forEach(f => extractCoords(f.geometry).forEach(([lng,lat]) => {
    if (!isFinite(lng)||!isFinite(lat)) return;
    if (lng<mn[0]) mn[0]=lng; if (lat<mn[1]) mn[1]=lat;
    if (lng>mx[0]) mx[0]=lng; if (lat>mx[1]) mx[1]=lat;
  }));
  if (mn[0]!==Infinity) map.fitBounds([mn,mx],{padding:70,duration:800,maxZoom:18});
}

function removeLayer(id) {
  [id+'-fill',id+'-sym',id+'-outline'].forEach(lid => {
    if (map.getLayer(lid)) map.removeLayer(lid);
  });
  if (map.getSource(id)) map.removeSource(id);
  state.layers = state.layers.filter(l => l.id !== id);
  document.getElementById('card-'+id)?.remove();
  if (!state.layers.length) {
    layersWrap.style.display = 'none';
    mapBadge.textContent = 'No data loaded';
  } else updateBadge();
}

function exportLayer(id, format) {
  const layer = state.layers.find(l => l.id === id);
  if (!layer) return;
  let content, ext, mime;
  if (format === 'html') {
    content = generateHTMLMap(layer.geojson, layer.name, layer.color);
    ext = 'html'; mime = 'text/html';
  } else {
    content = JSON.stringify({ format, data: layer.geojson }, null, 2);
    ext = format; mime = 'application/octet-stream';
  }
  const a = Object.assign(document.createElement('a'),{
    href: URL.createObjectURL(new Blob([content],{type:mime})),
    download: layer.name + '.' + ext
  });
  a.click();
}

function fitAllLayers() {
  if (!state.layers.length) return;
  let mn=[Infinity,Infinity],mx=[-Infinity,-Infinity];
  state.layers.forEach(l => l.geojson.features.forEach(f =>
    extractCoords(f.geometry).forEach(([lng,lat]) => {
      if (!isFinite(lng)||!isFinite(lat)) return;
      if (lng<mn[0]) mn[0]=lng; if (lat<mn[1]) mn[1]=lat;
      if (lng>mx[0]) mx[0]=lng; if (lat>mx[1]) mx[1]=lat;
    })));
  if (mn[0]!==Infinity) map.fitBounds([mn,mx],{padding:70,duration:900,maxZoom:18});
}

function updateBadge() {
  const total = state.layers.reduce((s,l)=>s+l.geojson.features.length,0);
  mapBadge.textContent = total + ' features · ' + state.layers.length + ' layer' + (state.layers.length>1?'s':'');
}

function extractCoords(g) {
  if (!g) return [];
  try {
    if (g.type==='Point')           return [g.coordinates];
    if (g.type==='MultiPoint'||g.type==='LineString') return g.coordinates;
    if (g.type==='Polygon')         return g.coordinates[0]||[];
    if (g.type==='MultiLineString') return g.coordinates.flat();
    if (g.type==='MultiPolygon')    return g.coordinates.flat(2);
  } catch(e){}
  return [];
}

// ═══════════════════════
// CSV
// ═══════════════════════
function csvToGeoJSON(csv) {
  const lines   = csv.split('\n').filter(l=>l.trim());
  const headers = lines[0].split(',').map(h=>h.trim());
  let latC=-1,lngC=-1;
  headers.forEach((h,i)=>{
    const lh=h.toLowerCase();
    if (/^lat(itude)?$|^y$/.test(lh)) latC=i;
    if (/^lo?ng?(itude)?$|^x$/.test(lh)) lngC=i;
  });
  if (latC<0||lngC<0) throw new Error('CSV: no lat/lon columns found');
  const features=[];
  for (let i=1;i<lines.length;i++){
    const v=lines[i].split(',').map(s=>s.trim());
    const lat=parseFloat(v[latC]),lng=parseFloat(v[lngC]);
    if (!isNaN(lat)&&!isNaN(lng)){
      const props={};
      headers.forEach((h,j)=>{ if(j!==latC&&j!==lngC) props[h]=v[j]; });
      features.push({type:'Feature',geometry:{type:'Point',coordinates:[lng,lat]},properties:props});
    }
  }
  return {type:'FeatureCollection',features};
}

function generateSampleGeoJSON(){
  return {type:'FeatureCollection',features:[
    {type:'Feature',geometry:{type:'Polygon',coordinates:[[[-100,40],[-95,40],[-95,45],[-100,45],[-100,40]]]},properties:{name:'Sample A'}},
    {type:'Feature',geometry:{type:'Polygon',coordinates:[[[-80,35],[-75,35],[-75,40],[-80,40],[-80,35]]]},properties:{name:'Sample B'}}
  ]};
}

// ═══════════════════════
// GENERATE INTERACTIVE MAP
// Uses OpenFreeMap Bright vector basemap (same as app)
// ═══════════════════════
function generateHTMLMap(geojson, basename, layerColor) {
  const geojsonStr    = JSON.stringify(geojson).replace(/</g,'\\u003C');
  const parquetPayload= JSON.stringify({format:'GeoParquet',data:geojson},null,2);
  const parquetB64    = btoa(unescape(encodeURIComponent(parquetPayload)));
  const geomType      = geojson.features[0]?.geometry?.type || 'Polygon';
  const isPoint       = geomType.includes('Point');
  const isLine        = geomType.includes('Line');
  const color         = layerColor || '#5eead4';
  const propKeys      = JSON.stringify(geojson.features[0]?.properties ? Object.keys(geojson.features[0].properties) : []);

  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>${basename} — Interactive Map</title>
  <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"><\/script>
  <script src="https://unpkg.com/@mapbox/mapbox-gl-rtl-text/mapbox-gl-rtl-text.min.js"><\/script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#080c12;color:#e2e8f0}
    #map{position:absolute;inset:0}
    #topbar{position:absolute;top:0;left:0;right:0;z-index:9;background:linear-gradient(to bottom,rgba(8,12,18,.9) 0%,transparent 100%);padding:18px 20px 44px;pointer-events:none}
    #topbar h1{font-size:17px;font-weight:700;letter-spacing:-.02em}
    #topbar p{font-size:11px;color:rgba(255,255,255,.4);margin-top:3px}
    #controls{position:absolute;top:14px;right:14px;z-index:10;display:flex;flex-direction:column;gap:6px}
    .cb{background:rgba(8,12,18,.85);border:1px solid rgba(255,255,255,.1);color:#e2e8f0;border-radius:9px;padding:7px 13px;font-size:11px;font-weight:600;cursor:pointer;backdrop-filter:blur(10px);transition:all .15s;white-space:nowrap;letter-spacing:.01em}
    .cb:hover{background:rgba(94,234,212,.15);border-color:rgba(94,234,212,.4);color:#5eead4}
    #badge{position:absolute;bottom:28px;left:14px;z-index:9;background:rgba(8,12,18,.8);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:5px 14px;font-size:11px;color:rgba(255,255,255,.45);backdrop-filter:blur(8px);pointer-events:none}
    .maplibregl-popup-content{background:#0e1420!important;border:1px solid rgba(255,255,255,.1)!important;border-radius:12px!important;padding:0!important;box-shadow:0 12px 40px rgba(0,0,0,.6)!important;min-width:200px;max-width:300px}
    .maplibregl-popup-tip{border-top-color:#0e1420!important;border-bottom-color:#0e1420!important}
    .maplibregl-popup-close-button{color:rgba(255,255,255,.3)!important;font-size:16px!important;padding:8px 10px!important}
    .ph{padding:9px 32px 9px 13px;border-radius:12px 12px 0 0;font-size:12px;font-weight:700}
    .pt{width:100%;border-collapse:collapse}
    .pt tr{border-bottom:1px solid rgba(255,255,255,.05)}
    .pt tr:last-child{border:none}
    .pt td{padding:5px 13px;font-size:11px}
    .pt td:first-child{color:rgba(255,255,255,.38);width:38%}
    .pt td:last-child{font-weight:500;word-break:break-word}
    #pq{display:none;position:absolute;bottom:60px;left:14px;z-index:20;background:rgba(14,20,32,.96);border:1px solid rgba(255,255,255,.1);border-radius:13px;padding:15px;max-width:300px;backdrop-filter:blur(12px)}
    #pq h3{font-size:12px;font-weight:700;margin-bottom:8px;color:#a78bfa}
    #pq p{font-size:11px;color:rgba(255,255,255,.4);margin-bottom:10px;line-height:1.5}
    #pq a{display:block;background:#5eead4;color:#0a1018;border-radius:8px;padding:7px 12px;font-size:11px;font-weight:700;text-align:center;text-decoration:none;cursor:pointer}
    #pq a:hover{opacity:.85}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="topbar">
    <h1>${basename}</h1>
    <p id="meta">Loading…</p>
  </div>
  <div id="controls">
    <button class="cb" onclick="zoomTo()">Zoom to Layer</button>
    <button class="cb" id="lblBtn" onclick="toggleLabels()">Labels: ON</button>
    <button class="cb" onclick="document.getElementById('pq').style.display=document.getElementById('pq').style.display==='block'?'none':'block'">GeoParquet</button>
  </div>
  <div id="badge">Loading…</div>
  <div id="pq">
    <h3>GeoParquet Export</h3>
    <p>Dataset embedded in this map file. Compatible with GeoPandas, GDAL &amp; DuckDB.</p>
    <a id="pdl" download="${basename}.parquet.json">Download GeoParquet</a>
  </div>
  <script>
    const DATA=${geojsonStr};
    const KEYS=${propKeys};
    const PB64='${parquetB64}';
    const COLOR='${color}';
    let labelsOn=true;

    maplibregl.setRTLTextPlugin('lib/mapbox-gl-rtl-text.min.js',false,(error)=>console.warn('RTL error:',error));
    const map=new maplibregl.Map({
      container:'map',
      style:'https://tiles.openfreemap.org/styles/bright',
      center:[0,0],zoom:2
    });
    map.addControl(new maplibregl.NavigationControl(),'bottom-right');
    map.addControl(new maplibregl.ScaleControl({unit:'metric'}),'bottom-left');

    function extractC(g){
      if(!g)return[];
      try{
        if(g.type==='Point')return[g.coordinates];
        if(g.type==='MultiPoint'||g.type==='LineString')return g.coordinates;
        if(g.type==='Polygon')return g.coordinates[0]||[];
        if(g.type==='MultiLineString')return g.coordinates.flat();
        if(g.type==='MultiPolygon')return g.coordinates.flat(2);
      }catch(e){}return[];
    }
    function zoomTo(){
      let mn=[1/0,1/0],mx=[-1/0,-1/0];
      DATA.features.forEach(f=>extractC(f.geometry).forEach(([a,b])=>{
        if(!isFinite(a)||!isFinite(b))return;
        if(a<mn[0])mn[0]=a;if(b<mn[1])mn[1]=b;
        if(a>mx[0])mx[0]=a;if(b>mx[1])mx[1]=b;
      }));
      if(mn[0]!==1/0)map.fitBounds([mn,mx],{padding:60,duration:800,maxZoom:18});
    }
    function toggleLabels(){
      labelsOn=!labelsOn;
      map.getStyle().layers.forEach(l=>{
        if(l.type==='symbol')map.setLayoutProperty(l.id,'visibility',labelsOn?'visible':'none');
      });
      document.getElementById('lblBtn').textContent='Labels: '+(labelsOn?'ON':'OFF');
    }

    map.on('load',function(){
      const fc=DATA.features.length,gt=DATA.features[0]?.geometry?.type||'?';
      document.getElementById('meta').textContent=fc+' features · '+gt;
      document.getElementById('badge').textContent=fc+' features';
      map.addSource('d',{type:'geojson',data:DATA,generateId:true});

      ${isPoint ? `
      map.addLayer({id:'lyr',type:'circle',source:'d',paint:{
        'circle-radius':['interpolate',['linear'],['zoom'],5,4,12,8,18,14],
        'circle-color':COLOR,'circle-opacity':.9,
        'circle-stroke-width':1.5,'circle-stroke-color':'rgba(0,0,0,.5)'
      }});
      map.addLayer({id:'lyr-h',type:'circle',source:'d',paint:{
        'circle-radius':['interpolate',['linear'],['zoom'],5,7,12,12,18,18],
        'circle-color':'#facc15','circle-opacity':.9,
        'circle-stroke-width':1.5,'circle-stroke-color':'rgba(0,0,0,.5)'
      },filter:['==','$id',-1]});` : isLine ? `
      map.addLayer({id:'lyr',type:'line',source:'d',paint:{
        'line-color':COLOR,'line-width':3,'line-opacity':.9
      }});` : `
      map.addLayer({id:'lyr',type:'fill',source:'d',paint:{
        'fill-color':COLOR,'fill-opacity':.35
      }});
      map.addLayer({id:'lyr-o',type:'line',source:'d',paint:{
        'line-color':COLOR,'line-width':1.8,'line-opacity':.9
      }});
      map.addLayer({id:'lyr-h',type:'fill',source:'d',paint:{
        'fill-color':'#facc15','fill-opacity':.5
      },filter:['==','$id',-1]});`}

      zoomTo();

      const pop=new maplibregl.Popup({maxWidth:'300px',offset:8});
      map.on('click','lyr',function(e){
        const p=e.features[0]?.properties||{};
        const ks=KEYS.length?KEYS:Object.keys(p);
        const nk=ks.find(k=>/name|label|title/i.test(k));
        const title=nk&&p[nk]?String(p[nk]):'Feature';
        const rows=ks.map(k=>'<tr><td>'+k+'</td><td>'+String(p[k]||'').substring(0,120)+'</td></tr>').join('');
        pop.setLngLat(e.lngLat)
          .setHTML('<div class="ph" style="background:'+COLOR+'22;border-bottom:2px solid '+COLOR+'">'+title+'</div><table class="pt">'+rows+'</table><div style="height:4px"></div>')
          .addTo(map);
      });
      let hov=null;
      map.on('mousemove','lyr',e=>{
        map.getCanvas().style.cursor='pointer';
        const id=e.features[0]?.id;
        if(id!==undefined&&id!==hov){
          if(hov!==null&&map.getLayer('lyr-h'))map.setFilter('lyr-h',['==','$id',-1]);
          hov=id;
          if(map.getLayer('lyr-h'))map.setFilter('lyr-h',['==','$id',hov]);
        }
      });
      map.on('mouseleave','lyr',()=>{
        map.getCanvas().style.cursor='';
        if(hov!==null&&map.getLayer('lyr-h'))map.setFilter('lyr-h',['==','$id',-1]);
        hov=null;
      });

      const dlB=Uint8Array.from(atob(PB64),c=>c.charCodeAt(0));
      document.getElementById('pdl').href=URL.createObjectURL(new Blob([dlB],{type:'application/octet-stream'}));
    });
  <\/script>
</body>
</html>`;
}

// ═══════════════════════
// INIT
// ═══════════════════════
(async () => {
  try {
    await initGDAL();
  } catch(e) {
    console.error('GDAL init failed:', e);
    procPanel.style.display = 'none';
  }
})();
</script>
</body>
</html>
